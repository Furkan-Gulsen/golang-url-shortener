AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Globals:
  Function:
    MemorySize: 128
    Architectures:
      - arm64
    Handler: bootstrap
    Runtime: provided.al2
    Timeout: 5
    Tracing: Active
    Environment:
      Variables:
        SlackToken: !Ref SlackToken
        SlackChannelId: !Ref SlackChannelId
        LinkTableName: !Ref LinkTableName
        StatsTableName: !Ref StatsTableName

Parameters:
  SlackToken:
    Type: String
    Description: Slack Token
    Default: ''
  SlackChannelId:
    Type: String
    Description: Slack Channel ID
    Default: ''
  LinkTableName:
    Type: String
    Description: Link Table Name
    Default: link-table-db
  StatsTableName:
    Type: String
    Description: Stats Table Name
    Default: stats-table-db

Resources:
  GenerateLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: internal/adapters/functions/generate/
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /generate
            Method: PUT
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref LinkTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref StatsTableName
  RedirectLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: internal/adapters/functions/redirect/
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /t/{id}
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref LinkTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref StatsTableName
  StatsLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: internal/adapters/functions/stats/
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /stats
            Method: GET
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref LinkTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref StatsTableName
  NotificationLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: internal/adapters/functions/notification/
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /notification
            Method: POST
      Environment:
        Variables:
          SlackToken: !Ref SlackToken
          SlackChannelId: !Ref SlackChannelId
  DeleteLinkFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: internal/adapters/functions/delete/
      Events:
        Api:
          Type: HttpApi
          Properties:
            Path: /delete
            Method: DELETE
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref LinkTableName
        - DynamoDBCrudPolicy:
            TableName: !Ref StatsTableName
  LinkTableDB:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: link-table-db
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: id
          KeyType: HASH
  StatsTableDB:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: stats-table-db
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      BillingMode: PAY_PER_REQUEST
      KeySchema:
        - AttributeName: id
          KeyType: HASH
  ServerlessHttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      CorsConfiguration:
        AllowMethods:
          - GET
          - POST
        AllowOrigins:
          - '*'
  # UrlShortenerElastiCacheCluster:
  #   Type: AWS::ElastiCache::CacheCluster
  #   Properties:
  #     CacheNodeType: cache.t2.micro
  #     Engine: redis
  #     NumCacheNodes: 1
  #     CacheSubnetGroupName: !Ref UrlShortenerCacheSubnetGroup
  #     VpcSecurityGroupIds:
  #       - !Ref UrlShortenerSecurityGroup
  # UrlShortenerCacheSubnetGroup:
  #   Type: AWS::ElastiCache::SubnetGroup
  #   Properties:
  #     Description: ElastiCache Subnet Group for URL Shortener
  #     SubnetIds:
  #       - !Ref UrlShortenerSubnet
  # UrlShortenerSecurityGroup:
  #   Type: AWS::EC2::SecurityGroup
  #   Properties:
  #     GroupDescription: ElastiCache Security Group for URL Shortener
  #     VpcId: !Ref UrlShortenerVPC
  # UrlShortenerVPC:
  #   Type: AWS::EC2::VPC
  #   Properties:
  #     CidrBlock: 10.0.0.0/16
  #     EnableDnsSupport: true
  #     EnableDnsHostnames: true
  # UrlShortenerSubnet:
  #   Type: AWS::EC2::Subnet
  #   Properties:
  #     VpcId: !Ref UrlShortenerVPC
  #     CidrBlock: 10.0.1.0/24
  #     MapPublicIpOnLaunch: true
Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub https://${ServerlessHttpApi}.execute-api.${AWS::Region}.amazonaws.com/
  # RedisAddress:
  #   Description: Redis Cache
  #   Value: !Ref UrlShortenerElastiCacheCluster
  # RedisEndpoint:
  #   Description: Redis Cache Address
  #   Value: !GetAtt UrlShortenerElastiCacheCluster.RedisEndpoint.Address
